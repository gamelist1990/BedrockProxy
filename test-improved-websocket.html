<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Connection Test - Improved</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .connecting { background-color: #fff3cd; color: #856404; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .error { background-color: #f8d7da; color: #721c24; }
        button {
            margin: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .connect { background-color: #28a745; color: white; }
        .disconnect { background-color: #dc3545; color: white; }
        .test { background-color: #007bff; color: white; }
        .logs {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
        }
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; }
        .log-warn { color: #cc6600; }
        .log-success { color: #00aa00; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .stat-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ WebSocket Connection Test - Improved</h1>
    
    <div class="container">
        <div class="panel">
            <h2>æ¥ç¶šç®¡ç†</h2>
            <div id="status" class="status disconnected">åˆ‡æ–­ä¸­</div>
            
            <div>
                <button id="connectBtn" class="connect">æ¥ç¶š</button>
                <button id="disconnectBtn" class="disconnect">åˆ‡æ–­</button>
                <button id="pingBtn" class="test">Pingé€ä¿¡</button>
                <button id="subscribeBtn" class="test">è³¼èª­ãƒ†ã‚¹ãƒˆ</button>
            </div>
            
            <h3>æ¥ç¶šçµ±è¨ˆ</h3>
            <div id="stats" class="stats-grid">
                <div class="stat-item">çŠ¶æ…‹: <span id="statStatus">-</span></div>
                <div class="stat-item">ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: <span id="statLatency">-</span>ms</div>
                <div class="stat-item">å†æ¥ç¶šå›æ•°: <span id="statReconnects">0</span></div>
                <div class="stat-item">æœ€çµ‚æ¥ç¶š: <span id="statLastConnected">-</span></div>
            </div>
        </div>
        
        <div class="panel">
            <h2>ã‚µãƒ¼ãƒãƒ¼æƒ…å ±</h2>
            <button id="getServersBtn" class="test">ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§å–å¾—</button>
            <button id="healthCheckBtn" class="test">ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</button>
            <div id="serverInfo" class="logs"></div>
        </div>
        
        <div class="panel">
            <h2>ğŸ¯ ã‚µãƒ¼ãƒãƒ¼æ“ä½œ</h2>
            <div style="margin: 10px 0;">
                <input type="text" id="server-id" placeholder="ã‚µãƒ¼ãƒãƒ¼ID" value="test-server-1" style="margin-right: 10px;">
                <button onclick="startServer()" class="test">ğŸš€ ã‚µãƒ¼ãƒãƒ¼é–‹å§‹</button>
                <button onclick="stopServer()" class="test">ğŸ›‘ ã‚µãƒ¼ãƒãƒ¼åœæ­¢</button>
                <button onclick="restartServer()" class="test">ğŸ”„ ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•</button>
            </div>
            
            <h3>ğŸ“ æ–°è¦ã‚µãƒ¼ãƒãƒ¼ä½œæˆ</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                <input type="text" id="server-name" placeholder="ã‚µãƒ¼ãƒãƒ¼å" value="ãƒ†ã‚¹ãƒˆã‚µãƒ¼ãƒãƒ¼">
                <input type="text" id="server-address" placeholder="å—ä¿¡ã‚¢ãƒ‰ãƒ¬ã‚¹" value="127.0.0.1:19132">
                <input type="text" id="server-destination" placeholder="è»¢é€å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹" value="192.168.1.10:19132">
                <input type="text" id="server-executable" placeholder="å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹" value="c:\\test_server\\bedrock_server.exe">
            </div>
            <button onclick="createServer()" class="test">â• ã‚µãƒ¼ãƒãƒ¼ä½œæˆ</button>
        </div>
    </div>
    
    <div class="panel" style="margin-top: 20px;">
        <h2>ãƒ­ã‚°</h2>
        <button onclick="clearLogs()" style="float: right;">ã‚¯ãƒªã‚¢</button>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        class ImprovedWebSocketTest {
            constructor() {
                this.ws = null;
                this.connectionState = 'disconnected';
                this.reconnectCount = 0;
                this.lastConnected = null;
                this.latency = 0;
                this.pingInterval = null;
                this.setupEventListeners();
                this.updateUI();
            }

            setupEventListeners() {
                document.getElementById('connectBtn').onclick = () => this.connect();
                document.getElementById('disconnectBtn').onclick = () => this.disconnect();
                document.getElementById('pingBtn').onclick = () => this.sendPing();
                document.getElementById('subscribeBtn').onclick = () => this.testSubscribe();
                document.getElementById('getServersBtn').onclick = () => this.getServers();
                document.getElementById('healthCheckBtn').onclick = () => this.healthCheck();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('logs');
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${timestamp}] ${message}`;
                logElement.appendChild(entry);
                logElement.scrollTop = logElement.scrollHeight;
            }

            updateUI() {
                const statusEl = document.getElementById('status');
                const statStatusEl = document.getElementById('statStatus');
                const statLatencyEl = document.getElementById('statLatency');
                const statReconnectsEl = document.getElementById('statReconnects');
                const statLastConnectedEl = document.getElementById('statLastConnected');

                // çŠ¶æ…‹æ›´æ–°
                statusEl.className = `status ${this.connectionState}`;
                switch(this.connectionState) {
                    case 'connected':
                        statusEl.textContent = 'âœ… æ¥ç¶šæ¸ˆã¿';
                        break;
                    case 'connecting':
                        statusEl.textContent = 'ğŸ”„ æ¥ç¶šä¸­...';
                        break;
                    case 'disconnected':
                        statusEl.textContent = 'âŒ åˆ‡æ–­ä¸­';
                        break;
                    case 'error':
                        statusEl.textContent = 'âš ï¸ ã‚¨ãƒ©ãƒ¼';
                        break;
                }

                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                statStatusEl.textContent = this.connectionState;
                statLatencyEl.textContent = this.latency;
                statReconnectsEl.textContent = this.reconnectCount;
                statLastConnectedEl.textContent = this.lastConnected ? 
                    this.lastConnected.toLocaleTimeString() : '-';

                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–
                document.getElementById('connectBtn').disabled = 
                    this.connectionState === 'connected' || this.connectionState === 'connecting';
                document.getElementById('disconnectBtn').disabled = 
                    this.connectionState === 'disconnected';
                document.getElementById('pingBtn').disabled = 
                    this.connectionState !== 'connected';
                document.getElementById('subscribeBtn').disabled = 
                    this.connectionState !== 'connected';
                document.getElementById('getServersBtn').disabled = 
                    this.connectionState !== 'connected';
            }

            connect() {
                if (this.ws) {
                    this.ws.close();
                }

                this.connectionState = 'connecting';
                this.updateUI();
                this.log('WebSocketæ¥ç¶šã‚’é–‹å§‹...');

                this.ws = new WebSocket('ws://localhost:8080');

                this.ws.onopen = () => {
                    this.connectionState = 'connected';
                    this.lastConnected = new Date();
                    this.log('WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ', 'success');
                    this.updateUI();
                    
                    // è‡ªå‹•è³¼èª­
                    this.subscribe(['*']);
                    
                    // å®šæœŸçš„ãªPingé–‹å§‹
                    this.startPinging();
                };

                this.ws.onmessage = (event) => {
                    this.handleMessage(event.data);
                };

                this.ws.onclose = (event) => {
                    this.connectionState = 'disconnected';
                    this.log(`WebSocketåˆ‡æ–­: ${event.code} - ${event.reason}`, 'warn');
                    this.updateUI();
                    this.stopPinging();
                    
                    // äºˆæœŸã—ãªã„åˆ‡æ–­ã®å ´åˆã¯å†æ¥ç¶š
                    if (event.code !== 1000) {
                        this.scheduleReconnect();
                    }
                };

                this.ws.onerror = (error) => {
                    this.connectionState = 'error';
                    this.log('WebSocketã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                    this.updateUI();
                };
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close(1000, 'User disconnect');
                }
                this.stopPinging();
            }

            scheduleReconnect() {
                if (this.reconnectCount >= 5) {
                    this.log('æœ€å¤§å†æ¥ç¶šå›æ•°ã«é”ã—ã¾ã—ãŸ', 'error');
                    return;
                }

                const delay = Math.min(1000 * Math.pow(2, this.reconnectCount), 30000);
                this.reconnectCount++;
                this.log(`${delay}mså¾Œã«å†æ¥ç¶šã—ã¾ã™ (${this.reconnectCount}/5)`, 'warn');
                
                setTimeout(() => {
                    this.connect();
                }, delay);
            }

            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    
                    // Pongãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
                    if (message.type === 'pong') {
                        const latency = Date.now() - (message.timestamp || 0);
                        this.latency = latency;
                        this.log(`Pongå—ä¿¡ (ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: ${latency}ms)`);
                        this.updateUI();
                        return;
                    }

                    // æ¥ç¶šç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    if (message.type === 'connection') {
                        this.log(`æ¥ç¶šç¢ºèª: ${message.data?.clientId}`, 'success');
                        return;
                    }

                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    if (message.type === 'event') {
                        this.log(`ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡: ${message.event}`, 'info');
                        return;
                    }

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    if (message.type === 'response') {
                        this.log(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(message.data)}`);
                        
                        // ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                        if (message.data?.servers) {
                            this.displayServerInfo(message.data.servers);
                        }
                        return;
                    }

                    this.log(`å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${JSON.stringify(message)}`);

                } catch (error) {
                    this.log(`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }

            sendMessage(message) {
                if (this.ws?.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                    return true;
                }
                this.log('WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return false;
            }

            sendPing() {
                const timestamp = Date.now();
                if (this.sendMessage({ type: 'ping', timestamp })) {
                    this.log('Pingé€ä¿¡');
                }
            }

            subscribe(events) {
                if (this.sendMessage({ 
                    type: 'subscribe', 
                    events, 
                    id: 'subscribe_' + Date.now() 
                })) {
                    this.log(`è³¼èª­ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${events.join(', ')}`);
                }
            }

            testSubscribe() {
                this.subscribe(['server.update', 'player.join']);
            }

            getServers() {
                if (this.sendMessage({ 
                    type: 'servers.getAll', 
                    id: 'getServers_' + Date.now() 
                })) {
                    this.log('ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡');
                }
            }

            displayServerInfo(servers) {
                const serverInfoEl = document.getElementById('serverInfo');
                serverInfoEl.innerHTML = `
                    <h4>ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§ (${servers.length}å°)</h4>
                    ${servers.map(server => `
                        <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <strong>${server.name}</strong><br>
                            <small>çŠ¶æ…‹: ${server.status} | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${server.playersOnline}/${server.maxPlayers}</small>
                        </div>
                    `).join('')}
                `;
            }

            startPinging() {
                this.pingInterval = setInterval(() => {
                    this.sendPing();
                }, 10000); // 10ç§’é–“éš”
            }

            stopPinging() {
                if (this.pingInterval) {
                    clearInterval(this.pingInterval);
                    this.pingInterval = null;
                }
            }

            async healthCheck() {
                try {
                    const response = await fetch('http://localhost:8080/health');
                    const data = await response.json();
                    this.log(`ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: ${JSON.stringify(data)}`, 'success');
                    
                    const serverInfoEl = document.getElementById('serverInfo');
                    serverInfoEl.innerHTML = `
                        <h4>ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹</h4>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            <div>çŠ¶æ…‹: ${data.status}</div>
                            <div>æ¥ç¶šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ•°: ${data.clients}</div>
                            <div>ç”Ÿå­˜ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ•°: ${data.aliveClients || 'N/A'}</div>
                            <div>å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: ${data.avgLatency || 'N/A'}ms</div>
                            <div>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${new Date(data.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                } catch (error) {
                    this.log(`ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }

            // ã‚µãƒ¼ãƒãƒ¼æ“ä½œãƒ¡ã‚½ãƒƒãƒ‰
            createServer() {
                const serverData = {
                    name: document.getElementById('server-name').value,
                    address: document.getElementById('server-address').value,
                    destinationAddress: document.getElementById('server-destination').value,
                    executablePath: document.getElementById('server-executable').value,
                    maxPlayers: 20,
                    autoRestart: true,
                    blockSameIP: false
                };
                
                this.log(`ã‚µãƒ¼ãƒãƒ¼ä½œæˆ: ${serverData.name}`, 'info');
                this.sendRequest('createServer', serverData);
            }
            
            startServer() {
                const serverId = document.getElementById('server-id').value;
                if (!serverId) {
                    this.log('ã‚µãƒ¼ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warn');
                    return;
                }
                this.log(`ã‚µãƒ¼ãƒãƒ¼é–‹å§‹: ${serverId}`, 'info');
                this.sendRequest('startServer', { serverId });
            }
            
            stopServer() {
                const serverId = document.getElementById('server-id').value;
                if (!serverId) {
                    this.log('ã‚µãƒ¼ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warn');
                    return;
                }
                this.log(`ã‚µãƒ¼ãƒãƒ¼åœæ­¢: ${serverId}`, 'info');
                this.sendRequest('stopServer', { serverId });
            }
            
            restartServer() {
                const serverId = document.getElementById('server-id').value;
                if (!serverId) {
                    this.log('ã‚µãƒ¼ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warn');
                    return;
                }
                this.log(`ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•: ${serverId}`, 'info');
                this.sendRequest('restartServer', { serverId });
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
        function createServer() {
            testApp.createServer();
        }
        
        function startServer() {
            testApp.startServer();
        }
        
        function stopServer() {
            testApp.stopServer();
        }
        
        function restartServer() {
            testApp.restartServer();
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        const testApp = new ImprovedWebSocketTest();
    </script>
</body>
</html>