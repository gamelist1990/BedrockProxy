<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Connection Test - Improved</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .connecting { background-color: #fff3cd; color: #856404; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .error { background-color: #f8d7da; color: #721c24; }
        button {
            margin: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .connect { background-color: #28a745; color: white; }
        .disconnect { background-color: #dc3545; color: white; }
        .test { background-color: #007bff; color: white; }
        .logs {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
        }
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; }
        .log-warn { color: #cc6600; }
        .log-success { color: #00aa00; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .stat-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>🚀 WebSocket Connection Test - Improved</h1>
    
    <div class="container">
        <div class="panel">
            <h2>接続管理</h2>
            <div id="status" class="status disconnected">切断中</div>
            
            <div>
                <button id="connectBtn" class="connect">接続</button>
                <button id="disconnectBtn" class="disconnect">切断</button>
                <button id="pingBtn" class="test">Ping送信</button>
                <button id="subscribeBtn" class="test">購読テスト</button>
            </div>
            
            <h3>接続統計</h3>
            <div id="stats" class="stats-grid">
                <div class="stat-item">状態: <span id="statStatus">-</span></div>
                <div class="stat-item">レイテンシ: <span id="statLatency">-</span>ms</div>
                <div class="stat-item">再接続回数: <span id="statReconnects">0</span></div>
                <div class="stat-item">最終接続: <span id="statLastConnected">-</span></div>
            </div>
        </div>
        
        <div class="panel">
            <h2>サーバー情報</h2>
            <button id="getServersBtn" class="test">サーバー一覧取得</button>
            <button id="healthCheckBtn" class="test">ヘルスチェック</button>
            <div id="serverInfo" class="logs"></div>
        </div>
        
        <div class="panel">
            <h2>🎯 サーバー操作</h2>
            <div style="margin: 10px 0;">
                <input type="text" id="server-id" placeholder="サーバーID" value="test-server-1" style="margin-right: 10px;">
                <button onclick="startServer()" class="test">🚀 サーバー開始</button>
                <button onclick="stopServer()" class="test">🛑 サーバー停止</button>
                <button onclick="restartServer()" class="test">🔄 サーバー再起動</button>
            </div>
            
            <h3>📝 新規サーバー作成</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                <input type="text" id="server-name" placeholder="サーバー名" value="テストサーバー">
                <input type="text" id="server-address" placeholder="受信アドレス" value="127.0.0.1:19132">
                <input type="text" id="server-destination" placeholder="転送先アドレス" value="192.168.1.10:19132">
                <input type="text" id="server-executable" placeholder="実行ファイルパス" value="c:\\test_server\\bedrock_server.exe">
            </div>
            <button onclick="createServer()" class="test">➕ サーバー作成</button>
        </div>
    </div>
    
    <div class="panel" style="margin-top: 20px;">
        <h2>ログ</h2>
        <button onclick="clearLogs()" style="float: right;">クリア</button>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        class ImprovedWebSocketTest {
            constructor() {
                this.ws = null;
                this.connectionState = 'disconnected';
                this.reconnectCount = 0;
                this.lastConnected = null;
                this.latency = 0;
                this.pingInterval = null;
                this.setupEventListeners();
                this.updateUI();
            }

            setupEventListeners() {
                document.getElementById('connectBtn').onclick = () => this.connect();
                document.getElementById('disconnectBtn').onclick = () => this.disconnect();
                document.getElementById('pingBtn').onclick = () => this.sendPing();
                document.getElementById('subscribeBtn').onclick = () => this.testSubscribe();
                document.getElementById('getServersBtn').onclick = () => this.getServers();
                document.getElementById('healthCheckBtn').onclick = () => this.healthCheck();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('logs');
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${timestamp}] ${message}`;
                logElement.appendChild(entry);
                logElement.scrollTop = logElement.scrollHeight;
            }

            updateUI() {
                const statusEl = document.getElementById('status');
                const statStatusEl = document.getElementById('statStatus');
                const statLatencyEl = document.getElementById('statLatency');
                const statReconnectsEl = document.getElementById('statReconnects');
                const statLastConnectedEl = document.getElementById('statLastConnected');

                // 状態更新
                statusEl.className = `status ${this.connectionState}`;
                switch(this.connectionState) {
                    case 'connected':
                        statusEl.textContent = '✅ 接続済み';
                        break;
                    case 'connecting':
                        statusEl.textContent = '🔄 接続中...';
                        break;
                    case 'disconnected':
                        statusEl.textContent = '❌ 切断中';
                        break;
                    case 'error':
                        statusEl.textContent = '⚠️ エラー';
                        break;
                }

                // 統計情報更新
                statStatusEl.textContent = this.connectionState;
                statLatencyEl.textContent = this.latency;
                statReconnectsEl.textContent = this.reconnectCount;
                statLastConnectedEl.textContent = this.lastConnected ? 
                    this.lastConnected.toLocaleTimeString() : '-';

                // ボタンの有効/無効化
                document.getElementById('connectBtn').disabled = 
                    this.connectionState === 'connected' || this.connectionState === 'connecting';
                document.getElementById('disconnectBtn').disabled = 
                    this.connectionState === 'disconnected';
                document.getElementById('pingBtn').disabled = 
                    this.connectionState !== 'connected';
                document.getElementById('subscribeBtn').disabled = 
                    this.connectionState !== 'connected';
                document.getElementById('getServersBtn').disabled = 
                    this.connectionState !== 'connected';
            }

            connect() {
                if (this.ws) {
                    this.ws.close();
                }

                this.connectionState = 'connecting';
                this.updateUI();
                this.log('WebSocket接続を開始...');

                this.ws = new WebSocket('ws://localhost:8080');

                this.ws.onopen = () => {
                    this.connectionState = 'connected';
                    this.lastConnected = new Date();
                    this.log('WebSocket接続が確立されました', 'success');
                    this.updateUI();
                    
                    // 自動購読
                    this.subscribe(['*']);
                    
                    // 定期的なPing開始
                    this.startPinging();
                };

                this.ws.onmessage = (event) => {
                    this.handleMessage(event.data);
                };

                this.ws.onclose = (event) => {
                    this.connectionState = 'disconnected';
                    this.log(`WebSocket切断: ${event.code} - ${event.reason}`, 'warn');
                    this.updateUI();
                    this.stopPinging();
                    
                    // 予期しない切断の場合は再接続
                    if (event.code !== 1000) {
                        this.scheduleReconnect();
                    }
                };

                this.ws.onerror = (error) => {
                    this.connectionState = 'error';
                    this.log('WebSocketエラーが発生しました', 'error');
                    this.updateUI();
                };
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close(1000, 'User disconnect');
                }
                this.stopPinging();
            }

            scheduleReconnect() {
                if (this.reconnectCount >= 5) {
                    this.log('最大再接続回数に達しました', 'error');
                    return;
                }

                const delay = Math.min(1000 * Math.pow(2, this.reconnectCount), 30000);
                this.reconnectCount++;
                this.log(`${delay}ms後に再接続します (${this.reconnectCount}/5)`, 'warn');
                
                setTimeout(() => {
                    this.connect();
                }, delay);
            }

            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    
                    // Pongレスポンス処理
                    if (message.type === 'pong') {
                        const latency = Date.now() - (message.timestamp || 0);
                        this.latency = latency;
                        this.log(`Pong受信 (レイテンシ: ${latency}ms)`);
                        this.updateUI();
                        return;
                    }

                    // 接続確認メッセージ
                    if (message.type === 'connection') {
                        this.log(`接続確認: ${message.data?.clientId}`, 'success');
                        return;
                    }

                    // イベントメッセージ
                    if (message.type === 'event') {
                        this.log(`イベント受信: ${message.event}`, 'info');
                        return;
                    }

                    // レスポンスメッセージ
                    if (message.type === 'response') {
                        this.log(`レスポンス: ${JSON.stringify(message.data)}`);
                        
                        // サーバー情報を表示
                        if (message.data?.servers) {
                            this.displayServerInfo(message.data.servers);
                        }
                        return;
                    }

                    this.log(`受信メッセージ: ${JSON.stringify(message)}`);

                } catch (error) {
                    this.log(`メッセージ解析エラー: ${error.message}`, 'error');
                }
            }

            sendMessage(message) {
                if (this.ws?.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                    return true;
                }
                this.log('WebSocketが接続されていません', 'error');
                return false;
            }

            sendPing() {
                const timestamp = Date.now();
                if (this.sendMessage({ type: 'ping', timestamp })) {
                    this.log('Ping送信');
                }
            }

            subscribe(events) {
                if (this.sendMessage({ 
                    type: 'subscribe', 
                    events, 
                    id: 'subscribe_' + Date.now() 
                })) {
                    this.log(`購読リクエスト: ${events.join(', ')}`);
                }
            }

            testSubscribe() {
                this.subscribe(['server.update', 'player.join']);
            }

            getServers() {
                if (this.sendMessage({ 
                    type: 'servers.getAll', 
                    id: 'getServers_' + Date.now() 
                })) {
                    this.log('サーバー一覧リクエスト送信');
                }
            }

            displayServerInfo(servers) {
                const serverInfoEl = document.getElementById('serverInfo');
                serverInfoEl.innerHTML = `
                    <h4>サーバー一覧 (${servers.length}台)</h4>
                    ${servers.map(server => `
                        <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                            <strong>${server.name}</strong><br>
                            <small>状態: ${server.status} | プレイヤー: ${server.playersOnline}/${server.maxPlayers}</small>
                        </div>
                    `).join('')}
                `;
            }

            startPinging() {
                this.pingInterval = setInterval(() => {
                    this.sendPing();
                }, 10000); // 10秒間隔
            }

            stopPinging() {
                if (this.pingInterval) {
                    clearInterval(this.pingInterval);
                    this.pingInterval = null;
                }
            }

            async healthCheck() {
                try {
                    const response = await fetch('http://localhost:8080/health');
                    const data = await response.json();
                    this.log(`ヘルスチェック: ${JSON.stringify(data)}`, 'success');
                    
                    const serverInfoEl = document.getElementById('serverInfo');
                    serverInfoEl.innerHTML = `
                        <h4>サーバー状態</h4>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            <div>状態: ${data.status}</div>
                            <div>接続クライアント数: ${data.clients}</div>
                            <div>生存クライアント数: ${data.aliveClients || 'N/A'}</div>
                            <div>平均レイテンシ: ${data.avgLatency || 'N/A'}ms</div>
                            <div>タイムスタンプ: ${new Date(data.timestamp).toLocaleString()}</div>
                        </div>
                    `;
                } catch (error) {
                    this.log(`ヘルスチェックエラー: ${error.message}`, 'error');
                }
            }

            // サーバー操作メソッド
            createServer() {
                const serverData = {
                    name: document.getElementById('server-name').value,
                    address: document.getElementById('server-address').value,
                    destinationAddress: document.getElementById('server-destination').value,
                    executablePath: document.getElementById('server-executable').value,
                    maxPlayers: 20,
                    autoRestart: true,
                    blockSameIP: false
                };
                
                this.log(`サーバー作成: ${serverData.name}`, 'info');
                this.sendRequest('createServer', serverData);
            }
            
            startServer() {
                const serverId = document.getElementById('server-id').value;
                if (!serverId) {
                    this.log('サーバーIDを入力してください', 'warn');
                    return;
                }
                this.log(`サーバー開始: ${serverId}`, 'info');
                this.sendRequest('startServer', { serverId });
            }
            
            stopServer() {
                const serverId = document.getElementById('server-id').value;
                if (!serverId) {
                    this.log('サーバーIDを入力してください', 'warn');
                    return;
                }
                this.log(`サーバー停止: ${serverId}`, 'info');
                this.sendRequest('stopServer', { serverId });
            }
            
            restartServer() {
                const serverId = document.getElementById('server-id').value;
                if (!serverId) {
                    this.log('サーバーIDを入力してください', 'warn');
                    return;
                }
                this.log(`サーバー再起動: ${serverId}`, 'info');
                this.sendRequest('restartServer', { serverId });
            }
        }

        // グローバル関数（HTMLから呼び出し用）
        function createServer() {
            testApp.createServer();
        }
        
        function startServer() {
            testApp.startServer();
        }
        
        function stopServer() {
            testApp.stopServer();
        }
        
        function restartServer() {
            testApp.restartServer();
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // アプリケーション開始
        const testApp = new ImprovedWebSocketTest();
    </script>
</body>
</html>