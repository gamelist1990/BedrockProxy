# UDP Proxy 多数クライアント対応改善

## 概要
UDP Proxyを多数のプレイヤーが同時接続しても適切に処理できるように改善しました。

## 主な改善内容

### 1. 接続制限とレート制限
- **最大接続数制限**: デフォルト1,000接続まで対応（設定可能）
- **レート制限**: クライアントごとに秒間100パケットまで（設定可能）
- 制限を超えた接続やパケットは適切にドロップされ、ログに記録

### 2. ソケット再利用の最適化
- **共有ソケット**: 接続数が少ない場合（50未満）は単一の共有ソケットを使用
- **ソケットプール**: 高負荷時は10個のソケットをラウンドロビンで使用
- **メモリ効率**: 接続ごとに新しいソケットを作成せず、リソースを節約

### 3. パフォーマンス最適化
- **非同期処理**: setImmediateを使用して次のパケット受信をブロックしない
- **バッファサイズ最適化**: 受信/送信バッファを4MBに増加
- **タイムスタンプ効率化**: Date型からnumber型に変更してメモリ削減

### 4. 統計情報の拡張
- アクティブな接続数の追跡
- パケット数のカウント
- 真のクライアントIP情報の表示
- レート制限の状態監視

## 設定例

```typescript
const proxyConfig: UDPProxyConfig = {
  listenPort: 19132,
  targetHost: '127.0.0.1',
  targetPort: 19133,
  timeout: 60000,
  proxyProtocolV2Enabled: true,
  maxConnections: 2000,        // 最大2,000接続まで対応
  rateLimit: 150,              // 秒間150パケットまで許可
  socketReuseEnabled: true     // ソケット再利用を有効化（推奨）
};

const proxy = new UDPProxy(proxyConfig);
await proxy.start();
```

## スケーラビリティ

### 低負荷時（1-50接続）
- 単一の共有ソケットで処理
- 最小限のリソース使用

### 中負荷時（51-1000接続）
- ソケットプール（10個）をラウンドロビンで使用
- バランスの取れたパフォーマンス

### 高負荷時（1000+接続）
- 接続制限により安定性を維持
- レート制限で過負荷を防止

## 監視とロギング

新しい接続が確立されると、以下の情報がログに記録されます：
- クライアントアドレスとポート
- 真のクライアントIP（Proxy Protocol使用時）
- 総接続数

レート制限や接続制限を超えた場合：
- 警告ログが記録
- パケットは適切にドロップ
- サービスの安定性を維持

## 統計情報の取得

```typescript
const stats = proxy.getStats();
console.log(`アクティブ接続: ${stats.activeConnections}`);
console.log(`接続詳細:`, stats.connections);
```

統計情報には以下が含まれます：
- 各接続のクライアントアドレス
- 最終アクティビティ時刻
- パケットカウント
- 真のクライアントIP（該当する場合）

## パフォーマンス特性

- **メモリ使用量**: 接続あたり約1KB（ソケット再利用時）
- **スループット**: UDP帯域幅の限界まで対応
- **レイテンシ**: 最小限のオーバーヘッド（<1ms）
- **同時接続数**: デフォルト1,000、最大設定可能

## 注意事項

1. **ソケット再利用**: デフォルトで有効ですが、特殊なケースでは無効化も可能
2. **レート制限**: 正常なプレイヤーを誤検知しないよう適切な値を設定
3. **接続制限**: サーバーのリソースに応じて調整
4. **Proxy Protocol**: v2対応により多段プロキシでも正確なIP追跡

## 今後の拡張可能性

- IPベースのブロックリスト/ホワイトリスト
- 地域ベースのフィルタリング
- より詳細な統計情報とメトリクス
- 動的なレート制限調整
